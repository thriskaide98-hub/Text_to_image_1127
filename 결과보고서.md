# 도로 이미지 기반 필지 추출 및 토지이용 계획 생성 결과 보고서

## 1. 프로젝트 개요

본 프로젝트는 도로 이미지와 마스크 이미지를 입력으로 받아, 자동으로 필지(parcel)를 추출하고 LLM을 활용하여 토지이용 계획을 생성한 후 시각화하는 파이프라인을 구축했습니다.

### 1.1 처리 규모
- **총 처리 건수**: 426개 사이트
- **생성된 필지 데이터**: 426개 JSON 파일 (`result/1.parcels/`)
- **생성된 토지이용 계획**: 426개 JSON 파일 (`result/2.1plans/`)
- **생성된 렌더링 이미지**: 12개 PNG 파일 (`result/3.1landuse_flat/`)

### 1.2 처리 파이프라인
```
도로 이미지 + 마스크 이미지
    ↓ [1단계: 필지 추출]
필지 폴리곤 JSON
    ↓ [2단계: LLM 기반 토지이용 할당]
토지이용 계획 JSON
    ↓ [3단계: 시각화]
토지이용 렌더링 이미지
```

---

## 2. 단계별 상세 분석

### 2.1 1단계: 도로 기반 필지 추출 (`1.roads_to_parcels_1127.py`)

#### 2.1.1 목적
도로 이미지(`{id}_condition.png`)와 마스크 이미지(`{id}_mask.png`)를 입력받아, 도로를 제외한 빈 공간에서 필지(parcel) 폴리곤을 자동 추출합니다.

#### 2.1.2 주요 알고리즘

**1) 도로 영역 식별**
- 그레이스케일 변환 후 임계값(threshold < 220) 적용
- 어두운 픽셀을 도로로 간주
- 마스크 외부 영역은 모두 도로로 처리

**2) 도로 영역 확장**
- Morphological dilation 연산 적용 (3×3 커널, 2회 반복)
- 필지 간 간격 확보를 위한 전처리

**3) 필지 마스크 생성**
- 대상지 내부(`mask >= 128`)이면서 도로가 아닌 영역 추출
- Erosion 연산(1회)으로 필지 경계 정제

**4) Connected Components 분석**
- `cv2.connectedComponents`로 독립된 필지 영역 분리
- 최소 면적 필터링: 1,500 픽셀 미만 제거
- 경계 접촉 필지 제거 (외곽 필터링)

**5) 폴리곤 추출**
- `cv2.findContours`로 외곽선 추출
- `cv2.approxPolyDP`로 폴리곤 단순화 (epsilon=2.0)
- 픽셀 좌표를 사이트 좌표계(0~1000m)로 변환

#### 2.1.3 출력 형식
```json
{
  "site": {
    "width_m": 1000.0,
    "height_m": 1000.0
  },
  "parcels": [
    {
      "id": "P001",
      "area_px": 7095.0,
      "centroid_norm": [0.079, 0.765],
      "polygon": [[x1, y1], [x2, y2], ...]
    },
    ...
  ]
}
```

#### 2.1.4 주요 파라미터
- **이미지 해상도**: 1024×1024 픽셀
- **도로 임계값**: 220 (그레이스케일)
- **최소 필지 면적**: 1,500 픽셀
- **사이트 크기**: 1000m × 1000m

---

### 2.2 2단계: LLM 기반 토지이용 할당 (`2.plan_from_parcel_llm_1127_copy.py`)

#### 2.2.1 목적
추출된 필지 정보를 LLM(GPT-4.1-mini)에 전달하여 각 필지에 적절한 토지이용 유형을 할당합니다.

#### 2.2.2 토지이용 유형
- **Residential** (주거용지): 60% 목표 비율
- **Commercial** (상업용지): 20% 목표 비율
- **Public** (공공용지): 10% 목표 비율
- **Green** (녹지): 10% 목표 비율

#### 2.2.3 필지 요약 정보 생성

LLM에 전달하기 전, 폴리곤 데이터는 제외하고 요약 정보만 추출:

**1) 면적 등급 분류**
- Quantile 기반 분류 (20%, 80% 기준)
  - `small`: 하위 20%
  - `medium`: 중간 60%
  - `large`: 상위 20%

**2) 위치 태깅**
- 수평 위치: `left` (< 0.33), `center` (0.33~0.66), `right` (> 0.66)
- 수직 위치: `bottom` (< 0.33), `middle` (0.33~0.66), `top` (> 0.66)
- 조합 예: `center_top`, `left_bottom` 등

#### 2.2.4 LLM 프롬프트 전략

**입력 데이터**:
- 사이트 정보 (크기)
- 목표 토지이용 비율
- 전체 면적 합계
- 필지 요약 정보 (id, area_px, area_rank, centroid, position_tag)

**할당 휴리스틱**:
- 중심부 또는 주요 도로변의 대형 필지 → Commercial/Public 우선
- 외곽 필지 → Residential/Green 우선
- 중간 크기 필지 중 중심부 → Public (학교, 공공시설 등)
- 전체 면적 비율이 목표 비율에 근접하도록 조정

#### 2.2.5 출력 형식
```json
{
  "site": {...},
  "parcels": [
    {
      "id": "P001",
      "area_px": 7095.0,
      "centroid_norm": [0.079, 0.765],
      "polygon": [...],
      "land_use": "Residential"
    },
    ...
  ],
  "target_share": {
    "Residential": 0.6,
    "Commercial": 0.2,
    "Public": 0.1,
    "Green": 0.1
  }
}
```

#### 2.2.6 기술적 세부사항
- **모델**: GPT-4.1-mini
- **Temperature**: 0.3 (일관성 확보)
- **JSON 파싱**: 마크다운 코드 블록 제거 후 파싱
- **오류 처리**: 누락된 필지는 기본값 "Residential" 할당

---

### 2.3 3단계: 토지이용 시각화 (`3.render_landuse_from_json_1127_copy.py`)

#### 2.3.1 목적
토지이용 계획 JSON을 읽어 색상으로 구분된 평면도를 생성하고, 도로 네트워크를 함께 표시합니다.

#### 2.3.2 색상 체계
- **Residential** (주거용지): `#fff59d` (연노랑)
- **Commercial** (상업용지): `#ef5350` (빨강)
- **Public** (공공용지): `#42a5f5` (파랑)
- **Green** (녹지): `#66bb6a` (초록)
- **도로**: `#dddddd` (밝은 회색), 테두리 검정

#### 2.3.3 도로 폴리곤 추출

1단계와 유사한 로직으로 도로 영역을 추출하되, 렌더링에 최적화:

**1) 마스크 확장**
- 30×30 커널로 dilation (외곽 도로 포함)

**2) 도로 바이너리 생성**
- 임계값 < 220 적용
- 확장된 마스크 내부만 유지

**3) 도로 두께 확장**
- 3×3 커널, 4회 dilation (도로 폭 안정화)

**4) 폴리곤 변환**
- 최소 면적 500 픽셀 이상만 유지
- `approxPolyDP`로 단순화

#### 2.3.4 렌더링 순서
1. **도로 폴리곤** 먼저 그리기 (zorder=1, 회색)
2. **필지 폴리곤** 그 위에 그리기 (zorder=2, 토지이용 색상)

#### 2.3.5 출력 사양
- **해상도**: 300 DPI
- **크기**: 6×6 인치
- **형식**: PNG (투명 배경)
- **파일명**: `{id}_landuse_flat_with_roads.png`

---

## 3. 결과 통계

### 3.1 처리 현황
- **총 사이트 수**: 426개
- **필지 추출 성공**: 426개 (100%)
- **토지이용 할당 완료**: 426개 (100%)
- **렌더링 완료**: 12개 (샘플)

### 3.2 샘플 데이터 분석 (000번 사이트 기준)
- **추출된 필지 수**: 약 13개
- **필지 면적 범위**: 3,867 ~ 147,452 픽셀
- **토지이용 분포**:
  - Residential: 다수
  - Commercial: 대형 필지 중심부
  - Public: 중소형 필지
  - Green: 일부 필지

---

## 4. 기술적 특징 및 개선사항

### 4.1 강점
1. **자동화된 파이프라인**: 이미지 입력부터 최종 시각화까지 전 과정 자동화
2. **LLM 활용**: 도시계획 전문가의 휴리스틱을 LLM으로 구현
3. **확장 가능한 구조**: 모듈화된 설계로 각 단계 독립 실행 가능
4. **정확한 폴리곤 추출**: Connected Components와 Contour 기반 정밀 추출

### 4.2 개선 가능 영역
1. **도로 임계값**: 현재 고정값(220) 사용, 데이터에 따라 자동 조정 가능
2. **필지 최소 면적**: 현재 1,500 픽셀 고정, 사이트 크기에 따라 동적 조정
3. **LLM 프롬프트**: 더 구체적인 도시계획 규칙 추가 가능
4. **렌더링 품질**: 고해상도 출력 옵션 추가 가능

### 4.3 파라미터 민감도
- **도로 임계값**: 필지 추출 정확도에 직접 영향
- **Dilation 반복 횟수**: 필지 간 간격 조절
- **Epsilon 값**: 폴리곤 단순화 정도 (현재 2.0)

---

## 5. 파일 구조

```
프로젝트 루트/
├── input/
│   ├── roads/          # 도로 이미지 ({id}_condition.png)
│   └── masks/          # 마스크 이미지 ({id}_mask.png)
├── result/
│   ├── 1.parcels/      # 필지 추출 결과 JSON
│   ├── 2.1plans/       # 토지이용 계획 JSON
│   └── 3.1landuse_flat/ # 렌더링 이미지 PNG
├── 1.roads_to_parcels_1127.py
├── 2.plan_from_parcel_llm_1127_copy.py
└── 3.render_landuse_from_json_1127_copy.py
```

---

## 6. 결론

본 프로젝트는 컴퓨터 비전 기반 필지 추출과 LLM 기반 토지이용 계획 생성을 결합한 자동화 파이프라인을 성공적으로 구축했습니다. 

**주요 성과**:
- 426개 사이트에 대한 필지 추출 및 토지이용 계획 생성 완료
- 도시계획 전문가의 휴리스틱을 LLM으로 구현하여 일관된 계획 생성
- 시각화를 통한 결과 검증 가능

**향후 활용 방안**:
- 도시계획 초안 작성 지원 도구
- 대규모 개발 사업의 토지이용 계획 자동 생성
- 다양한 시나리오 비교 분석

---

## 부록: 주요 코드 로직 요약

### A. 필지 추출 핵심 로직
```python
# 도로 바이너리 생성
road_binary = cond_gray < 220
road_binary[mask_np < 128] = True

# 도로 확장
road_dilated = cv2.dilate(road_binary, kernel, iterations=2)

# 필지 마스크
parcel_mask = (mask_np >= 128) & (road_dilated == 0)
parcel_mask = cv2.erode(parcel_mask, kernel, iterations=1)

# Connected Components
num_labels, labels = cv2.connectedComponents(parcel_mask)
```

### B. LLM 프롬프트 구조
- 필지 요약 정보만 전달 (폴리곤 제외)
- 목표 비율 명시
- 위치 기반 휴리스틱 제공
- JSON 형식 강제

### C. 렌더링 순서
1. 도로 폴리곤 (회색, zorder=1)
2. 필지 폴리곤 (토지이용 색상, zorder=2)

---

**보고서 작성일**: 2024년
**프로젝트**: 도로 이미지 기반 필지 추출 및 토지이용 계획 생성
**버전**: 1.0

