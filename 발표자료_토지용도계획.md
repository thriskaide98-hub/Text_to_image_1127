# 도로 네트워크 기반 자동 토지용도 계획 생성
## LLM과 지식 그래프를 활용한 접근

---

## Slide 1: 제목

**도로 네트워크 기반 자동 토지용도 계획 생성**

LLM과 지식 그래프를 활용한 접근

[연구자명 / 소속]

---

## Slide 2: 연구 배경 및 목적

### 연구 배경
- 도시 계획 초기 단계에서 **토지용도 배치**는 반복적이면서도 중요한 작업
- 기존 방식: 전문가의 경험과 직관에 의존
- **자동화 필요성**: 효율성 향상 및 일관성 있는 계획 수립

### 연구 목적
- **도로 네트워크 이미지**를 입력으로 받아 **토지 파셀을 자동 추출**
- **LLM과 지식 그래프**를 활용하여 각 파셀에 적절한 토지용도 할당
- **시각화**를 통해 계획 결과를 직관적으로 확인

---

## Slide 3: 전체 워크플로우

```
[0단계] 이미지 입력
  ↓ 도로 네트워크 + 경계 마스크
[1단계] 파셀 추출 (컴퓨터 비전)
  ↓ Connected Components + Contour
[2단계] 토지용도 할당
  ├─ [방법 1] LLM 기반 할당
  │   └─ GPT-4.1-mini + 프롬프트 엔지니어링
  └─ [방법 2] 지식 그래프 기반 할당
      └─ Neo4j + Context-Rule-LandUse 체인
[3단계] 결과 시각화
  ↓ 색상 구분 이미지 생성 (LLM/KG 비교)
```

**핵심 특징**
- 완전 자동화된 파이프라인
- 두 가지 할당 방법 비교 가능
- 기계 판독 가능한 JSON 출력

---

## Slide 4: 0단계 - 입력 데이터

### 입력 이미지
- **도로 네트워크 이미지** (`{id}_condition.png`)
  - 도로 영역이 어두운 색상으로 표시
  - 그레이스케일 임계값 < 220 → 도로로 인식
  
- **경계 마스크 이미지** (`{id}_mask.png`)
  - 대상지 영역을 흰색(≥128), 외부를 검정(<128)으로 표시

### 목표
- 도로를 제외한 **빈 공간(대지)**에서 **토지 파셀** 자동 추출

---

## Slide 5: 1단계 - 파셀 추출 (컴퓨터 비전)

### 주요 알고리즘

**1) 도로 영역 식별**
```python
road_binary = cond_gray < 220  # 임계값 기반
road_dilated = cv2.dilate(road_binary, iterations=2)  # 도로 확장
```

**2) 필지 마스크 생성**
```python
parcel_mask = (mask >= 128) & (road_dilated == 0)
parcel_mask = cv2.erode(parcel_mask, iterations=1)  # 경계 정제
```

**3) Connected Components 분석**
- 독립된 필지 영역 분리
- 최소 면적 필터링 (1,500 픽셀)
- 경계 접촉 필지 제거

**4) 폴리곤 추출**
- `cv2.findContours` → 외곽선 추출
- `cv2.approxPolyDP` → 폴리곤 단순화
- 픽셀 좌표 → 사이트 좌표계(0~1000m) 변환

### 출력
- `{id}_parcels.json`: 각 파셀의 ID, 면적, 중심점, 폴리곤 좌표

---

## Slide 6: 2단계 - 토지용도 할당 (방법 1: LLM)

### LLM 기반 접근

**입력 데이터**
- 파셀 요약 정보 (ID, 면적, 위치 태그)
- 목표 토지용도 비율 (Residential 60%, Commercial 20%, Public 10%, Green 10%)

**프롬프트 전략**
```
You are an expert urban planner AI.
- Large parcels near center → Commercial/Public
- Outer-edge parcels → Residential/Green
- Medium parcels near intersections → Public
- Ensure total area matches target share
```

**모델**: GPT-4.1-mini (Temperature: 0.3)

### 출력
- `{id}_landuse.json`: 각 파셀에 `land_use` 필드 추가
- 4가지 토지용도: **Residential** (연노랑), **Commercial** (빨강), **Public** (파랑), **Green** (초록)

---

## Slide 7: 2단계 - 토지용도 할당 (방법 2: 지식 그래프)

### Neo4j 기반 공간-지식 그래프

**그래프 구조**
```
Block (사이트)
  └─[:CONTAINS]→ Parcel (필지)
       └─[:HAS_CONTEXT]→ Context (맥락)
            └─[:APPLIES_TO]→ Rule (규칙)
                 └─[:RECOMMENDS]→ LandUse (토지용도)
```

**노드 구성**

1. **Context** (6개 패턴)
   - `small_center`, `medium_center`, `large_center`
   - `small_edge`, `medium_edge`, `large_edge`
   - 각 Context는 `area_rank` + `pos_group` 조합

2. **Rule** (6개 규칙)
   - R1: "중심 큰 필지 → 상업" (weight: 1.0)
   - R2: "중심 중간 필지 → 공공" (weight: 0.7)
   - R3: "중심 작은 필지 → 주거" (weight: 0.6)
   - R4: "외곽 큰 필지 → 주거" (weight: 0.8)
   - R5: "외곽 작은 필지 → 녹지" (weight: 0.9)
   - R6: "외곽 중간 필지 → 주거" (weight: 0.75)

3. **LandUse** (4개)
   - Residential, Commercial, Public, Green

**할당 로직**
1. Parcel의 `area_rank` + `pos_group` → Context 매칭
2. Context에 연결된 Rule → LandUse 경로 탐색
3. Rule의 `RECOMMENDS` 관계로 `land_use_kg` 자동 할당

### 장점
- **명시적 규칙**: 의사결정 과정이 투명하고 추적 가능
- **일관성**: 동일 조건에서 항상 동일 결과 (결정론적)
- **확장성**: 규칙 추가/수정이 용이 (Cypher 쿼리로 관리)
- **효율성**: 로컬 그래프 쿼리로 빠른 처리

---

## Slide 8: 3단계 - 결과 시각화

### 렌더링 과정

**1) 도로 폴리곤 추출**
- 1단계와 동일한 로직으로 도로 영역 재추출
- 도로 확장 (4회 dilation) → 시각적 안정성

**2) 파셀 폴리곤 렌더링**
- 토지용도별 색상 적용
- 도로는 회색, 파셀은 토지용도 색상

**3) 레이어링**
- 도로 (zorder=1) → 파셀 (zorder=2)

### 출력 이미지
- `{id}_landuse_flat_with_roads.png` (LLM 기반)
- `{id}_landuse_kg_with_roads.png` (KG 기반)
- 해상도: 300 DPI, 6×6 인치

---

## Slide 9: 실험 결과

### 처리 규모
- **총 사이트 수**: 426개
- **평균 파셀 수**: 사이트당 약 10~15개
- **처리 성공률**: 100%
- **LLM 결과 파일**: 12개 (샘플)
- **KG 렌더링 이미지**: 426개 (전체)

### 결과 예시

**LLM 기반 결과**
- 목표 비율에 근접한 토지용도 분포
  - Residential: ~60% (목표: 60%)
  - Commercial: ~20% (목표: 20%)
  - Public: ~10% (목표: 10%)
  - Green: ~10% (목표: 10%)
- 위치 기반 휴리스틱 적용
- 일부 변동성 존재 (Temperature 0.3 영향)

**KG 기반 결과**
- 규칙 기반으로 일관된 할당
- Context 패턴에 따른 명확한 분류
  - `large_center` → Commercial (R1)
  - `medium_center` → Public (R2)
  - `small_edge` → Green (R5)
- 예측 가능하고 재현 가능한 결과

---

## Slide 10: LLM vs 지식 그래프 비교

### 정량적 비교

| 항목 | LLM 기반 | KG 기반 |
|------|----------|---------|
| **할당 방식** | 프롬프트 기반 추론 | 규칙 기반 매칭 |
| **일관성** | 중간 (Temperature 영향) | 높음 (결정론적) |
| **투명성** | 낮음 (블랙박스) | 높음 (명시적 규칙) |
| **유연성** | 높음 (자연어 프롬프트) | 중간 (규칙 수정 필요) |
| **계산 비용** | 높음 (API 호출) | 낮음 (로컬 쿼리) |
| **처리 속도** | 느림 (~초 단위) | 빠름 (밀리초 단위) |
| **재현성** | 낮음 (확률적) | 높음 (완전 재현) |

### 장단점 분석

**LLM 기반**
- ✅ 장점: 복잡한 맥락 이해, 자연어로 규칙 표현 가능
- ❌ 단점: API 비용, 일관성 이슈, 블랙박스 특성

**KG 기반**
- ✅ 장점: 명확하고 효율적, 완전한 재현성, 투명한 의사결정
- ❌ 단점: 규칙 설계 필요, 복잡한 예외 처리 어려움

### 활용 시나리오
- **LLM**: 초기 탐색, 복잡한 맥락이 필요한 경우
- **KG**: 표준화된 패턴, 일관성과 효율성이 중요한 경우

---

## Slide 11: 향후 연구 방향

### 하이브리드 접근: LLM + KG 결합

**전략 1: 2단계 파이프라인**
1. **1차 할당**: KG 규칙으로 기본 토지용도 할당 (빠르고 일관적)
2. **2차 보정**: LLM이 예외 케이스나 복잡한 맥락 처리
3. **검증**: 두 결과 비교 및 통합

**전략 2: 규칙 학습**
- LLM 결과를 분석하여 새로운 Rule 생성
- KG에 자동으로 Rule 추가
- 점진적 지식 축적

**전략 3: 가중치 조정**
- Rule의 weight를 LLM 결과와 비교하여 최적화
- 데이터 기반 규칙 개선

### 기대 효과
- ✅ **효율성**: KG로 대부분 처리 (비용 절감)
- ✅ **정확도**: LLM으로 예외 처리 (품질 향상)
- ✅ **투명성**: 규칙 기반 + LLM 설명 (해석 가능)
- ✅ **확장성**: 자동 규칙 학습 (지속적 개선)

---

## Slide 12: 결론

### 주요 성과
- ✅ **도로 네트워크 이미지**에서 자동 파셀 추출 성공 (426개 사이트)
- ✅ **LLM 기반** 토지용도 할당 구현 (GPT-4.1-mini 활용)
- ✅ **지식 그래프 기반** 토지용도 할당 구현 (Neo4j + 6개 Rule)
- ✅ 두 방법의 결과 시각화 및 비교 가능
- ✅ 엔드투엔드 자동화 파이프라인 구축

### 연구 기여도
1. **기술적 기여**
   - 컴퓨터 비전 + LLM + 지식 그래프 통합 파이프라인
   - 도시 계획 초기 단계 자동화 프레임워크 제시

2. **방법론적 기여**
   - LLM과 지식 그래프의 장단점 비교 분석
   - 하이브리드 접근법 제안

3. **실용적 기여**
   - 반복적 작업 자동화로 시간 절약
   - 일관성 있는 계획 수립 지원

### 향후 계획
- **하이브리드 방식** 개발 및 평가
- 대규모 데이터셋에서 성능 평가
- 전문가 평가를 통한 결과 검증
- 규칙 자동 학습 메커니즘 개발

---

## Slide 14: 감사합니다

**질문 및 토론 환영**

[연락처 정보]

---

## Slide 13: 데이터 및 모델 스펙

### 입력 데이터

**이미지 데이터**
- **형식**: PNG (RGB, Grayscale)
- **해상도**: 1024×1024 픽셀 (통일 처리)
- **도로 이미지** (`{id}_condition.png`)
  - 그레이스케일 임계값 < 220 → 도로 영역
  - 도로 네트워크 구조 정보 포함
- **마스크 이미지** (`{id}_mask.png`)
  - 대상지 영역: 흰색 (≥128)
  - 외부 영역: 검정 (<128)

**데이터셋 규모**
- **총 사이트 수**: 426개
- **평균 파셀 수**: 사이트당 8~15개
- **파셀 면적 범위**: 약 3,867 ~ 147,452 픽셀
- **사이트 크기**: 1000m × 1000m (고정)

### 사용 모델 및 기술

**LLM 모델**
- **모델**: OpenAI GPT-4.1-mini
- **Temperature**: 0.3 (일관성 확보)
- **API**: OpenAI Python SDK (v1.0+)
- **입력 토큰**: 평균 ~500-800 tokens/사이트
- **출력 형식**: JSON (구조화된 토지용도 할당)

**지식 그래프**
- **플랫폼**: Neo4j (Cloud)
- **그래프 구조**:
  - Block 노드: 426개 (사이트)
  - Parcel 노드: ~5,000개 (필지)
  - Context 노드: 6개 (패턴)
  - Rule 노드: 6개 (규칙)
  - LandUse 노드: 4개 (토지용도)
- **관계**: CONTAINS, HAS_CONTEXT, APPLIES_TO, RECOMMENDS

**컴퓨터 비전**
- **라이브러리**: OpenCV (v4.5+), Pillow (v8.0+)
- **주요 연산**:
  - Morphological operations (dilation, erosion)
  - Connected Components 분석
  - Contour detection 및 polygon approximation

### 소프트웨어 환경

**프로그래밍 언어**: Python 3.7+
**주요 라이브러리**:
- `numpy` ≥ 1.21.0 (수치 연산)
- `opencv-python` ≥ 4.5.0 (이미지 처리)
- `Pillow` ≥ 8.0.0 (이미지 I/O)
- `matplotlib` ≥ 3.5.0 (시각화)
- `openai` ≥ 1.0.0 (LLM API)
- `neo4j` (그래프 데이터베이스)

### 처리 성능

**1단계 (파셀 추출)**
- 처리 속도: ~1-2초/사이트
- 메모리 사용: ~100-200MB

**2단계 (토지용도 할당)**
- LLM: ~2-5초/사이트 (API 호출 포함)
- KG: ~10-50ms/사이트 (로컬 쿼리)

**3단계 (시각화)**
- 렌더링 속도: ~0.5-1초/사이트
- 출력 해상도: 300 DPI

---

## 부록: 기술적 세부사항

### 주요 파라미터
- **이미지 해상도**: 1024×1024 픽셀
- **사이트 크기**: 1000m × 1000m
- **도로 임계값**: 220 (그레이스케일)
- **최소 파셀 면적**: 1,500 픽셀
- **Dilation 반복**: 2회 (도로 확장)
- **Erosion 반복**: 1회 (경계 정제)
- **Polygon 단순화**: epsilon = 2.0

### 파일 구조
```
input/
  ├─ roads/     (도로 이미지: {id}_condition.png)
  └─ masks/     (경계 마스크: {id}_mask.png)

result/
  ├─ 1.parcels/           (파셀 JSON: 426개)
  ├─ 2.1plans/            (LLM 결과 JSON: 12개)
  ├─ 3.1landuse_flat/     (LLM 렌더링: 12개)
  └─ 3.2landuse_kg_flat_2/ (KG 렌더링: 426개)
```

